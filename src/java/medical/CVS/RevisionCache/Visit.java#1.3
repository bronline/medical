/*
 * Comment.java
 *
 * Created on November 28, 2005, 11:46 AM
 *
 * To change this template, choose Tools | Options and locate the template under
 * the Source Creation and Management node. Right-click the template and choose
 * Open. You can then make changes to the template in the Source Editor.
 */

package medical;
import tools.*;
import tools.utils.*;
import java.sql.*;

/**
 *
 * @author BR Online Solutions
 */
public class Visit extends RWResultSet {
    private String id;
    private int appointmentId=0;
    private int patientId=0; 
    private int locationId=0;
    private int conditionId=0;
    private Date date;
    private RWHtmlTable htmTb   = new RWHtmlTable("100%","0");
    private Timestamp timeStamp;
    private java.util.Date date1;
    private Appointment appointment;
    private Charge charge;
    private DoctorNote doctorNote;
    private PatientConditions condition;
    
    /** Creates a new instance of Visit */
    public Visit() {
        htmTb.replaceNLChar=false;
    }

    public Visit(RWConnMgr io, String ID) throws Exception {
        setConnMgr(io);
        setAppointment();
        setId(ID);
        htmTb.replaceNLChar=false;
    }

    public Visit(RWConnMgr io, int intId) throws Exception {
        setConnMgr(io);
        setAppointment();
        setId(intId);
        htmTb.replaceNLChar=false;
    }

    public void setId(int newId) throws Exception {
        setId("" + newId);
    }
    
    public void setId(String newId) throws Exception {
        id = newId;
        setResultSet(io.opnRS("select * from visits where id=" + id));
        refresh();
    }

    public void setAppointment() throws Exception {
        if(appointment == null) {
            appointment = new Appointment(io, appointmentId);
        } else {
            appointment.setId(appointmentId);
        }
    }
    
    public int getPatientId() {
        return patientId;
    }
    
    public String getInputForm(String patientId, String visitId) throws Exception {
    // Instantiate an RWInputForm and RWHtmlTable object
        RWInputForm frm = new RWInputForm(rs);
        RWHtmlTable htmTb = new RWHtmlTable ("650", "0");
        StringBuffer vf = new StringBuffer();

    // Set display attributes for the input form
        frm.setTableBorder("0");
        frm.setDftTextBoxSize("20");
        frm.setDftTextAreaCols("80");
        frm.setDftTextAreaRows("10");
        frm.setShowDatePicker(true);
        frm.setDisplayDeleteButton(true);
        frm.setLabelBold(true);
        frm.setUpdateButtonText("  save  ");
        frm.setDeleteButtonText("remove");

    // If adding a comment, Put the familyId and memberId on the form as hidden fields
        if(id.equals("0")) {
            String [] var       = { "patientid", "visitid" };
            String [] val       = { patientId, visitId };
            frm.setPreLoadFields(var);
            frm.setPreLoadValues(val);
        }

    // Get an input item with the record ID to set the rcd and ID fields
        frm.getInputItem("id");
        vf.append(frm.startForm());
        vf.append(htmTb.startTable());
        vf.append(frm.getInputItem("date"));
        vf.append(frm.getInputItem("comment"));
        vf.append(htmTb.endTable());
        vf.append(frm.updateButton());
        vf.append(frm.deleteButton());
        vf.append(frm.showHiddenFields());
        vf.append(frm.endForm());
        
        return vf.toString();
    }

    public int getId() {
        return Integer.parseInt(id);
    }

    public void setLastInsertedRow() throws Exception {
        ResultSet tmpRs  = io.opnRS("select LAST_INSERT_ID()");
        if(tmpRs.next()) {
            setId(tmpRs.getInt(1));
        }
        tmpRs.close();
    }
    
    public String getCharges() throws Exception {
        StringBuffer charges = new StringBuffer();
        charges.append(htmTb.startTable());
        charges.append(htmTb.startRow());
        charges.append(htmTb.addCell("Charges", "class=pageHeading"));
        charges.append(htmTb.endRow());
        charges.append(htmTb.endTable());
        
    // Create an RWFiltered List object to show the occupations
        RWFilteredList lst = new RWFilteredList(io);

    // Create an array with the column headings
        String [] columnHeadings = { "id",  "Procedure"};
        String myQuery = "select a.id, b.description, a.chargeamount from charges a join items b on a.itemid=b.id where visitid = " + id;

    // Set special attributes on the filtered list object
        lst.setTableBorder("0");
        lst.setCellPadding("1");
        lst.setCellSpacing("0");
        lst.setTableWidth("100%");
        lst.setAlternatingRowColors("white","lightgrey");
        lst.setUrlField(0);
        lst.setNumberOfColumnsForUrl(3);
        lst.setRowUrl("charges_d.jsp");
        lst.setOnClickAction("window.open");
        lst.setOnClickOption("\"" + "Charges" + "\",\"width=500,height=200,scrollbars=no,left=100,top=100,\"");
        lst.setOnClickStyle("style=\"cursor: pointer; color: #2c57a7; font-weight: bold;\"");
        lst.setShowRowUrl(true);
        lst.setShowComboBoxes(false);
        lst.setShowColumnHeadings(false);

    // Set specific column widths
        String [] cellWidths = {"0", "100", "100"};
        lst.setColumnWidth(cellWidths);

    // Show the list of charges
        charges.append("<div style=\"width: 400; height: 119; overflow: auto;\">" + lst.getHtml(myQuery, columnHeadings) + "</div>");
        
        return htmTb.getFrame(htmTb.BOTH, "","silver",0,charges.toString());
    }

    public String getAttention(String fontSize) throws Exception {
        String attnMsg="";
        StringBuffer attention = new StringBuffer();
        attention.append(htmTb.startTable("500"));
        attention.append(htmTb.startRow());
        attention.append(htmTb.addCell("Attention", "class=pageHeading"));
        attention.append(htmTb.endRow());
        attention.append(htmTb.endTable());
        
    // Show the attention message
        ResultSet lRs=io.opnRS("SELECT attentionMsg FROM patients where id=" + patientId);
        if (lRs.next()) {
            attnMsg=lRs.getString("attentionmsg");
            if (attnMsg==null) {
                attnMsg="";
            }
        } else {
            attnMsg="";
        }
        attention.append("<div style=\"font-size: " + fontSize + "; width: 400; height: 35; overflow: auto;\">" + attnMsg + "</div>");
        
        return htmTb.getFrame(htmTb.BOTH, "","silver",0,attention.toString());
    }

    public String getProcedures() throws Exception {
        StringBuffer charges = new StringBuffer();
        // Added 10-14-07 add a field to determine if the visit has charges
        int numCharges=0;
        
        charges.append(htmTb.startTable("500"));
        charges.append(htmTb.startRow());
        charges.append(htmTb.addCell("Procedures", "class=pageHeading"));
        charges.append(htmTb.endRow());
        charges.append(htmTb.endTable());
        
    // Create an RWFiltered List object to show the occupations
        RWFilteredList lst = new RWFilteredList(io);

    // Create an array with the column headings
        String [] columnHeadings = { "id",  "Item", "Charge"};
        String myQuery = "select a.id, b.description from charges a join items b on a.itemid=b.id where visitid = " + id;
        
        // Added 10-14-07 to determine if the visit has charges
        ResultSet tmpRs=io.opnRS(myQuery);
        if(tmpRs.next()) { numCharges=1; }
        charges.append("<input type=hidden name=enableSpaceBar value=" + numCharges + ">");
        tmpRs.close();
        tmpRs=null;
            
    // Set special attributes on the filtered list object
        lst.setTableBorder("0");
        lst.setCellPadding("1");
        lst.setCellSpacing("0");
        lst.setTableWidth("480");
        lst.setAlternatingRowColors("white","lightgrey");
        lst.setUrlField(0);
        lst.setNumberOfColumnsForUrl(2);
        lst.setRowUrl("charges_d.jsp");
        lst.setOnClickAction("window.open");
        lst.setOnClickOption("\"" + "Charges" + "\",\"width=500,height=200,scrollbars=no,left=100,top=100,\"");
        lst.setOnClickStyle("style=\"cursor: pointer; color: #2c57a7; font-weight: bold;\"");
        lst.setShowRowUrl(true);
        lst.setShowComboBoxes(false);
        lst.setShowColumnHeadings(false);

    // Set specific column widths
        String [] cellWidths = {"0", "200"};
        lst.setColumnWidth(cellWidths);

    // Show the list of charges
        charges.append("<div style=\"width: 500; height: 50; overflow-y: auto;\">" + lst.getHtml(myQuery, columnHeadings) + "</div>");

        return htmTb.getFrame(htmTb.BOTH, "","silver",0,charges.toString());
    }
    public String getComments() throws Exception {
        StringBuffer comments = new StringBuffer();
        comments.append(htmTb.startTable());
        comments.append(htmTb.startRow());
        comments.append(htmTb.addCell("Notes", "class=pageHeading"));
        comments.append(htmTb.endRow());
        comments.append(htmTb.endTable());
        
    // Create an RWFiltered List object to show the occupations
        RWFilteredList lst = new RWFilteredList(io);

    // Create an array with the column headings
        String [] columnHeadings = { "id",  "Comment"};
        String myQuery = "select id, comment from comments where visitid = " + id;

    // Set special attributes on the filtered list object
        lst.setTableBorder("0");
        lst.setCellPadding("1");
        lst.setCellSpacing("0");
        lst.setTableWidth("100%");
        lst.setAlternatingRowColors("white","lightgrey");
        lst.setUrlField(0);
        lst.setNumberOfColumnsForUrl(3);
        lst.setRowUrl("comments_d.jsp");
        lst.setShowRowUrl(true);
        lst.setOnClickAction("window.open");
        lst.setOnClickOption("\"" + "Comments" + "\",\"width=500,height=200,scrollbars=no,left=100,top=100,\"");
        lst.setOnClickStyle("style=\"cursor: pointer; color: #2c57a7; font-weight: bold;\"");
        lst.setShowComboBoxes(false);
        lst.setShowColumnHeadings(false);

    // Set specific column widths
        String [] cellWidths = {"0", "200"};
        lst.setColumnWidth(cellWidths);

    // Show the list of charges
        comments.append("<div style=\"width: 400; height: 90; overflow: auto;\">" + lst.getHtml(myQuery, columnHeadings) + "</div>");
        
        return htmTb.getFrame(htmTb.BOTH, "","silver",0,comments.toString());
    }

    public String getSOAPNotes() throws Exception {
        StringBuffer notes = new StringBuffer();
        notes.append(htmTb.startTable("500"));
        notes.append(htmTb.startRow());
        notes.append(htmTb.addCell("SOAP Notes", "class=pageHeading"));
        notes.append(htmTb.endRow());
        notes.append(htmTb.endTable());
        
    // Create an RWFiltered List object to show the occupations
        RWFilteredList lst = new RWFilteredList(io);

    // Create an array with the column headings
        String [] columnHeadings = { "id",  "Note"};
        String myQuery = "select id, note from doctornotes where visitid = " + id;

    // Set special attributes on the filtered list object
        lst.setTableBorder("0");
        lst.setCellPadding("1");
        lst.setCellSpacing("0");
        lst.setTableWidth("480");
        lst.setAlternatingRowColors("white","lightgrey");
        lst.setUrlField(0);
        lst.setNumberOfColumnsForUrl(3);
        lst.setRowUrl("doctornotes_d.jsp");
        lst.setShowRowUrl(true);
        lst.setOnClickAction("window.open");
        lst.setOnClickOption("\"" + "Comments" + "\",\"width=800,height=400,scrollbars=no,left=100,top=100,\"");
        lst.setOnClickStyle("style=\"cursor: pointer; color: #2c57a7; font-weight: bold;\"");
        lst.setShowComboBoxes(false);
        lst.setShowColumnHeadings(false);

    // Set specific column widths
        String [] cellWidths = {"0", "200"};
        lst.setColumnWidth(cellWidths);

    // Show the list of charges
        notes.append("<div style=\"width: 500; height: 115; overflow-y: auto;\">" + lst.getHtml(myQuery, columnHeadings) + "</div>");
        
        return htmTb.getFrame(htmTb.BOTH, "","silver",0,notes.toString());
    }
    
    public String getCondition() throws Exception {
        StringBuffer pc=new StringBuffer();
        
        pc.append("<div id=patientConditionBubble style='width: 225; height: 140;'>");
        pc.append(htmTb.startTable("225"));
        pc.append(htmTb.roundedTop(2,"","#030089",""));

    // Display the heading
        pc.append(htmTb.startRow());
        pc.append(htmTb.headingCell("Current Condition", "onMouseOver=this.style.cursor='pointer' onMouseOut=this.style.cursor='normal' onClick=showInputForm(event,'patientcondition.jsp',0," + this.patientId + ",txtHint)"));
        pc.append(htmTb.endRow());
        
        pc.append(htmTb.startCell(htmTb.LEFT));
        pc.append("<div id=patientCondition>" + getVisitCondition()+ "</div>");
        pc.append(htmTb.endCell());
        
        pc.append(htmTb.endTable());
        pc.append("</div>");
        return pc.toString();
    }
    
    public String getVisitCondition() throws Exception {
        if(condition == null) { condition = new PatientConditions(this.io,this.conditionId); }
        if(this.conditionId == 0) {
            this.conditionId=condition.getCurrentCondition(""+this.patientId);
        } else {
            this.conditionId=checkConditionId();
        }
        
        condition.setEditMode(true);
        
        return condition.getCondition(this.getConditionId());

    }

    public String getConditions() throws Exception {
        beforeFirst();
        if(condition == null) { condition=new PatientConditions(io,"0"); }
        if (!next() || id.equals("0")) {return "";}
        StringBuffer pc = new StringBuffer();
        condition.setEditMode(true);
        
        pc.append("<div id=previousConditions style='width: 225; height: 80;'>");
        pc.append(htmTb.startTable("100%"));
        pc.append(htmTb.roundedTop(2,"","#030089","previosuconditions"));

    // Display the heading
        pc.append(htmTb.startRow());
        pc.append(htmTb.headingCell("Conditions"));
        pc.append(htmTb.endRow());
        
        pc.append(htmTb.startRow());
        pc.append(htmTb.addCell("<div style='height: 80;'>" + condition.getConditionList(this.patientId) + "</div>"));
        pc.append(htmTb.endRow());
 
        pc.append(htmTb.endTable());
        pc.append("</div>");

        return pc.toString();       
    }

    public void setPatientId(int newPatientId) throws Exception {
        patientId = newPatientId;
    }
    
    public void setAppointmentId(int newAppointmentId) throws Exception {
        appointmentId = newAppointmentId;
    }
    
    public void setLocationId(int newLocationId) throws Exception {
        locationId = newLocationId;
    }
    
    public void setDate(Date newDate) throws Exception {
        date = newDate;
    }

    public void setTimestamp() throws Exception {
//        String currentDateString = new java.util.Date().toString(); 
//
//        long time1 = date1.parse(currentDateString);
//        timeStamp = new java.sql.Timestamp(time1);  
        timeStamp = new java.sql.Timestamp(System.currentTimeMillis());  
    }

    public void setResultSet(ResultSet newRs) throws Exception {
        super.setResultSet(newRs);
    }

    public void refresh() throws Exception {
        rs.beforeFirst();
        if (rs.next()) {
            id = rs.getString("id");
            appointmentId = rs.getInt("appointmentId");
            patientId = rs.getInt("patientId");
            date = rs.getDate("date");
            locationId = rs.getInt("locationId");
            conditionId = rs.getInt("conditionId");
            rs.beforeFirst();
        } else {
            id="0";
            appointmentId=0;
            patientId=0;
            locationId=0;
            conditionId=0;
        }
    }

    public void delete() throws Exception {
        rs.beforeFirst();
        if (rs.next()) {
            rs.deleteRow();
        }
    }

    public void update() throws Exception {
        setResultSet(io.opnUpdatableRS("select * from visits where id=" + id));
        rs.beforeFirst();
        setTimestamp();
        if (rs.next()) {
            rs.updateInt("appointmentid", appointmentId);
            rs.updateInt("patientid", patientId);
            rs.updateInt("locationid", locationId);
            rs.updateDate("date", date);
            rs.updateTimestamp("timein", timeStamp);
            rs.updateInt("conditionId", conditionId);
            rs.updateRow();
         } else {
            setDate(java.sql.Date.valueOf(Format.formatDate(new java.util.Date(), "yyyy-MM-dd")));
            moveToInsertRow();
            rs.updateInt("appointmentid", appointmentId);
            rs.updateInt("patientid", patientId);
            rs.updateInt("locationid", locationId);
            rs.updateDate("date", date);
            rs.updateTimestamp("timein", timeStamp);
            rs.updateInt("conditionId", conditionId);
            rs.insertRow();
            setLastInsertedRow();
        }
    }
    
    public void duplicateLastVisit(int visitId) throws Exception {
        ResultSet lRs=io.opnRS("SELECT * FROM visits where patientid=" + patientId + " order by `date` desc, timein desc");
        if(lRs.next()) {
            if(lRs.next()) {
                duplicateVisitCharges(lRs.getInt("id"));
                duplicateVisitNotes(lRs.getInt("id"));
            }
        }
        lRs.close();
    }
    
    public void duplicateVisitCharges(int visitId) throws Exception {
        if(charge == null) { charge=new Charge(io, "0"); }
        
        ResultSet cRs=io.opnRS("select * from charges where visitid=" + visitId);
        while(cRs.next()) {
            charge.setId(0);
            charge.setVisitId(Integer.parseInt(id));
            charge.setItemId(cRs.getInt("itemid"));
            charge.setResourceId(cRs.getInt("resourceId"));
            charge.setChargeAmount(cRs.getBigDecimal("chargeamount"));
            charge.setCopayAmount(cRs.getBigDecimal("copayamount"));
            charge.update();
        }
        cRs.close();
    }
    
    public void duplicateVisitNotes(int visitId) throws Exception {
        if(doctorNote == null) { doctorNote=new DoctorNote(io, "0"); }
        
        ResultSet nRs=io.opnRS("select * from doctornotes where visitid=" + visitId);
        while(nRs.next()) {
            doctorNote.setId(0);
            doctorNote.setVisitId(Integer.parseInt(id));
            doctorNote.setPatientId(nRs.getInt("patientid"));
            doctorNote.setNoteDate(this.date);
            doctorNote.setNote(nRs.getString("note"));
            doctorNote.update();
        }
        nRs.close();
    }
        
    public void undoVisit(int visitId) throws Exception {
        undoVisitCharges(visitId);
        undoVisitNotes(visitId);
    }
    
    public void undoVisitCharges(int visitId) throws Exception {
        PreparedStatement lPs=io.getConnection().prepareStatement("delete from charges where visitid=" + visitId);
        lPs.executeUpdate();
    }
    
    public void undoVisitNotes(int visitId) throws Exception {
        PreparedStatement lPs=io.getConnection().prepareStatement("delete from doctornotes where visitid=" + visitId);
        lPs.executeUpdate();        
    }

    public int getConditionId() {
        return conditionId;
    }

    public void setConditionId(int conditionId) {
        this.conditionId = conditionId;
    }

    private int checkConditionId() {
        int currentConditionId=0;
        try {
            ResultSet lRs=io.opnRS("select * from patientconditions where id=" + this.conditionId);
            if(lRs.next()) { currentConditionId=lRs.getInt("id"); }
            lRs.close();
            lRs=null;
        } catch (Exception e) {
        }
        
        return currentConditionId;
    }
}
